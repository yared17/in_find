<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detector IA — Metadatos EXIF</title>

  <!-- FAVICONS -->
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
  <link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#0b6dff">
  <meta name="theme-color" content="#0b1220">

  <!-- Preload del logo -->
  <link rel="preload" as="image" href="/assets/img/logo.png" imagesizes="24px">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#eef5ff',100:'#d9eaff',200:'#b0d1ff',300:'#86b7ff',400:'#5d9eff',
              500:'#3485ff',600:'#0b6dff',700:'#0959d1',800:'#07449c',900:'#052e66'
            }
          }
        }
      }
    }
  </script>

  <!-- EXIF/IPTC/XMP: usa exifr (full) -->
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>

  <style>
    .gradient-hero{
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(58,134,255,.35), rgba(58,134,255,0)),
        radial-gradient(900px 500px at 80% 20%, rgba(168,85,247,.35), rgba(168,85,247,0)),
        #0b1220;
    }
    .shadow-card{ box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .maxh-preview{ max-height: 480px; }
    .ring-soft{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
  </style>
</head>

<body class="bg-[#0b1220] text-white selection:bg-brand-300/30 selection:text-white">

  <!-- NAV -->
  <nav class="sticky top-0 z-50 bg-black/40 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-2">
        
        <span class="font-semibold">Detector IA</span>
      </div>
      <div class="hidden sm:flex items-center gap-6 text-sm text-white/80">
        <a href="#como" class="hover:text-white">Cómo Funciona</a>
        <a href="#faq" class="hover:text-white">FAQ</a>
        <button id="toggleTheme" class="p-2 rounded hover:bg-white/10" title="Tema">
          <svg id="moon" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="gradient-hero border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 pt-20 pb-24 text-center">
      <h1 class="text-4xl sm:text-6xl md:text-7xl font-extrabold tracking-tight leading-[1.05]">
        Detecta Imágenes<br/>
        <span class="bg-gradient-to-r from-brand-300 to-purple-400 bg-clip-text text-transparent">
          Modificadas por IA
        </span>
      </h1>
      <p class="mt-6 text-white/80 max-w-3xl mx-auto">
        Analiza EXIF/IPTC/XMP y cabeceras binarias para estimar si una imagen proviene de cámara real, red social, editor o IA.
      </p>
      <div class="mt-8">
        <button id="openPicker" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-brand-600 hover:bg-brand-500 text-white font-semibold shadow-card">
          Analizar Imagen
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="2" d="M12 5v14M5 12h14"/>
          </svg>
        </button>
      </div>
      <div class="mt-6 text-sm text-white/70">
        ✓ EXIF/IPTC/XMP • ✓ Cabeceras/segmentos • ✓ 100% local
      </div>
    </div>
  </header>

  <!-- UPLOAD -->
  <section class="max-w-6xl mx-auto px-4 -mt-14">
    <div id="dropArea" class="bg-white/5 ring-soft rounded-2xl p-10 text-center shadow-card">
      <p class="mb-4 text-white/80">Arrastra y suelta o haz clic para seleccionar una imagen</p>
      <div class="border-2 border-dashed border-white/15 rounded-xl py-14 cursor-pointer hover:border-white/25 transition">
        <svg class="w-12 h-12 mx-auto text-white/60" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-width="2" d="M3 15a4 4 0 0 0 4 4h10a4 4 0 0 0 4-4 5 5 0 0 0-5-5h-1A5 5 0 1 0 7 11H6a4 4 0 0 0-3 4z"/>
          <path stroke-width="2" d="M12 12v9m0-9l-3 3m3-3l3 3"/>
        </svg>
        <div class="mt-4 text-white/70 text-sm">
          Formatos: JPG / JPEG / PNG / WEBP / HEIC / TIFF • Máx. 25&nbsp;MB
        </div>
        <input id="fileInput" type="file"
          accept="image/jpeg,image/jpg,image/png,image/webp,image/heic,image/heif,image/tiff"
          class="hidden" />
      </div>
      <div id="uploadAlert" class="mt-4 text-sm text-red-300 hidden"></div>
    </div>
  </section>

  <!-- MODAL PREVIEW -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 backdrop-blur-sm p-4">
    <div class="bg-[#0f1629] border border-white/10 rounded-2xl max-w-4xl w-full shadow-card">
      <div class="flex items-center justify-between px-6 py-4 border-b border-white/10">
        <h3 class="font-semibold">Previsualización</h3>
        <button id="closeModal" class="p-2 hover:bg-white/10 rounded">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="p-6 grid md:grid-cols-2 gap-6">
        <div class="flex items-center justify-center">
          <img id="preview" class="rounded-lg border border-white/10 maxh-preview" alt="Vista previa"/>
        </div>
        <div class="flex flex-col gap-4">
          <div class="text-sm text-white/70">
            <div><span class="text-white/60">Archivo:</span> <span id="fileName">—</span></div>
            <div><span class="text-white/60">Tamaño:</span> <span id="fileSize">—</span></div>
            <div><span class="text-white/60">Tipo:</span> <span id="fileType">—</span></div>
          </div>
          <button id="btnAnalyze" class="mt-auto inline-flex items-center justify-center gap-2 px-5 py-3 rounded-lg bg-brand-600 hover:bg-brand-500 font-semibold">
            Analizar Imagen
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULTADOS -->
  <section id="results" class="max-w-6xl mx-auto px-4 mt-10 hidden">
    <div class="grid lg:grid-cols-2 gap-6">
      <!-- Imagen -->
      <div class="bg-white/5 ring-soft rounded-2xl p-5">
        <h4 class="font-semibold mb-4">Imagen Analizada</h4>
        <img id="resultImg" class="rounded-lg border border-white/10 max-h-[520px]" alt="Imagen analizada"/>
        <div class="mt-3 text-xs text-white/60" id="resultInfo"></div>
      </div>

      <!-- Diagnóstico -->
      <div class="bg-white/5 ring-soft rounded-2xl p-5">
        <div class="flex items-center gap-3">
          <div id="pillIcon" class="w-9 h-9 rounded-full flex items-center justify-center bg-red-500/20 text-red-300">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2" d="M12 9v4m0 4h.01M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18z"/>
            </svg>
          </div>
          <div class="text-lg font-semibold" id="pillText">Imagen Modificada/IA</div>
          <div class="ml-auto text-sm text-white/70">Confianza: <span id="confPct">—</span></div>
        </div>

        <!-- Barra -->
        <div class="mt-3 w-full h-2 bg-white/10 rounded">
          <div id="bar" class="h-2 rounded bg-gradient-to-r from-red-400 via-yellow-300 to-green-400" style="width: 0%"></div>
        </div>

        <!-- Advertencias -->
        <div class="mt-5">
          <h5 class="font-semibold mb-2">Advertencias</h5>
          <ul id="warnings" class="space-y-2 text-sm text-white/85 list-disc pl-5"></ul>
        </div>

        <!-- Indicadores -->
        <div class="mt-5 bg-black/20 rounded-xl p-4 border border-white/10">
          <h5 class="font-semibold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-white/70" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-width="2" d="M12 1l3 5 6 1-4 4 1 6-6-3-6 3 1-6-4-4 6-1 3-5z"/>
            </svg>
            Indicadores de Autenticidad
          </h5>
          <div id="indicators" class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm"></div>
        </div>

        <!-- Detalle -->
        <div class="mt-5">
          <details class="bg-black/20 rounded-xl p-4 border border-white/10">
            <summary class="cursor-pointer">Detalles Técnicos (Metadatos y Cabeceras)</summary>
            <div class="mt-3 overflow-auto max-h-64 mono text-[12px] leading-5 whitespace-pre-wrap" id="rawBox"></div>
          </details>
        </div>
      </div>
    </div>

    <!-- Datos clave / mapa -->
    <div id="keyWrap" class="bg-white/5 ring-soft rounded-2xl p-5 mt-6">
      <h5 class="font-semibold mb-3">Datos Clave</h5>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm" id="keyGrid"></div>
      <div id="mapLink" class="mt-3 text-sm"></div>
    </div>
  </section>

  <!-- CÓMO FUNCIONA -->
  <section id="como" class="max-w-6xl mx-auto px-4 mt-20">
    <h2 class="text-3xl font-extrabold mb-6">Cómo Funciona</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <div class="bg-white/5 ring-soft rounded-2xl p-6">
        <div class="text-white/70 mb-2">1. Sube tu Imagen</div>
        <p class="text-white/80 text-sm">Procesamos localmente en tu navegador.</p>
      </div>
      <div class="bg-white/5 ring-soft rounded-2xl p-6">
        <div class="text-white/70 mb-2">2. Análisis</div>
        <p class="text-white/80 text-sm">EXIF/IPTC/XMP + cabeceras binaras (formato, segmentos, recomprensión).</p>
      </div>
      <div class="bg-white/5 ring-soft rounded-2xl p-6">
        <div class="text-white/70 mb-2">3. Veredicto</div>
        <p class="text-white/80 text-sm">Heurísticas de origen (IA/red social/cámara) y puntaje de confianza.</p>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section id="faq" class="max-w-5xl mx-auto px-4 mt-20 mb-24">
    <h2 class="text-3xl font-extrabold mb-6">Preguntas Frecuentes</h2>
    <div class="space-y-3">
      <details class="bg-white/5 ring-soft rounded-xl p-4 border border-white/10">
        <summary class="cursor-pointer font-semibold">¿Qué analiza?</summary>
        <p class="mt-2 text-white/80 text-sm">EXIF/IPTC/XMP, tipo de archivo, segmentos JPEG (JFIF/EXIF/SOF), calidad JPEG estimada, software, cámara, fecha, GPS, tamaño real y hash.</p>
      </details>
      <details class="bg-white/5 ring-soft rounded-xl p-4 border border-white/10">
        <summary class="cursor-pointer font-semibold">¿Cómo detecta IA?</summary>
        <p class="mt-2 text-white/80 text-sm">Palabras clave (Midjourney/DALL·E/Stable Diffusion), ausencia de señas de cámara, recomprensión típica, software de edición y huellas de plataformas.</p>
      </details>
      <details class="bg-white/5 ring-soft rounded-xl p-4 border border-white/10">
        <summary class="cursor-pointer font-semibold">¿Privacidad?</summary>
        <p class="mt-2 text-white/80 text-sm">Todo se ejecuta localmente. No subimos nada.</p>
      </details>
    </div>
  </section>

  <!-- Input oculto adicional para abrir desde el hero -->
  <input id="hiddenFile" type="file"
         accept="image/jpeg,image/jpg,image/png,image/webp,image/heic,image/heif,image/tiff"
         class="hidden"/>

  <!-- SCRIPTS -->
  <script>
    /* ======= utilidades DOM ======= */
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    const fileInput = byId('fileInput');
    const hiddenFile = byId('hiddenFile');
    const openPicker = byId('openPicker');
    const dropArea = byId('dropArea');
    const uploadAlert = byId('uploadAlert');
    const modal = byId('modal');
    const closeModal = byId('closeModal');
    const preview = byId('preview');
    const fileName = byId('fileName');
    const fileSize = byId('fileSize');
    const fileType = byId('fileType');
    const btnAnalyze = byId('btnAnalyze');
    const results = byId('results');
    const resultImg = byId('resultImg');
    const resultInfo = byId('resultInfo');
    const pillText = byId('pillText');
    const pillIcon = byId('pillIcon');
    const confPct = byId('confPct');
    const bar = byId('bar');
    const warnings = byId('warnings');
    const indicators = byId('indicators');
    const rawBox = byId('rawBox');
    const keyGrid = byId('keyGrid');
    const mapLink = byId('mapLink');

    // Dark toggle (simple)
    byId('toggleTheme').onclick = () => document.documentElement.classList.toggle('dark');

    // Abrir selector desde el hero
    openPicker.onclick = () => hiddenFile.click();

    // Área de drop
    dropArea.addEventListener('click', () => fileInput.click());
    ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation();
      dropArea.classList.add('ring-2','ring-brand-400');
    }));
    ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation();
      dropArea.classList.remove('ring-2','ring-brand-400');
    }));
    dropArea.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if (f) handlePickedFile(f);
    });

    // Inputs
    [fileInput, hiddenFile].forEach(inp => {
      inp.addEventListener('change', e => {
        const f = e.target.files?.[0];
        if (f) handlePickedFile(f);
      });
    });

    function humanSize(bytes){ return (bytes/1024/1024).toFixed(2)+' MB'; }

    function handlePickedFile(file){
      uploadAlert.classList.add('hidden');
      // Validaciones
      const okType = /image\/(jpeg|jpg|png|webp|heic|heif|tiff)/i.test(file.type) || /\.(jpe?g|png|webp|heic|heif|tiff?)$/i.test(file.name);
      if(!okType){
        uploadAlert.textContent = 'Formato no soportado. Usa JPG/PNG/WEBP/HEIC/TIFF.';
        uploadAlert.classList.remove('hidden');
        return;
      }
      if(file.size > 25*1024*1024){
        uploadAlert.textContent = 'El archivo supera 25 MB. Sube una versión más ligera.';
        uploadAlert.classList.remove('hidden');
        return;
      }
      // Preview en modal
      const fr = new FileReader();
      fr.onload = () => {
        preview.src = fr.result;
        fileName.textContent = file.name;
        fileSize.textContent = humanSize(file.size);
        fileType.textContent = file.type || 'desconocido';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        btnAnalyze.onclick = () => analyzeFile(file, fr.result);
      };
      fr.readAsDataURL(file);
    }

    closeModal.onclick = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    function addWarn(text){
      const li = document.createElement('li');
      li.textContent = text;
      warnings.appendChild(li);
    }

    function addIndicator(label, ok){
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2 bg-black/20 border border-white/10 rounded-lg px-3 py-2';
      div.innerHTML = ok
        ? '<svg class="w-4 h-4 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
        : '<svg class="w-4 h-4 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      const span = document.createElement('span');
      span.textContent = label;
      div.appendChild(span);
      indicators.appendChild(div);
    }

    function putKey(label, value){
      if(value==null || value==='') return;
      const item = document.createElement('div');
      item.className = 'bg-black/20 border border-white/10 rounded-lg p-3';
      item.innerHTML = `
        <div class="text-white/60 text-xs">${label}</div>
        <div class="mt-1 text-sm">${value}</div>
      `;
      keyGrid.appendChild(item);
    }

    /* ======= helpers de metadatos/heurísticas ======= */

    const AI_SOFTWARE = [
      "midjourney","dall-e","dalle","stablediffusion","stable diffusion","novelai","runway",
      "lexica","leonardo","bing image creator","ideogram","firefly"
    ];
    const EDITORS = ["photoshop","lightroom","gimp","affinity","pixelmator","snapseed","vsco","canva","picsart","capcut","remini"];

    const PLATFORM_HINTS = [
      {name:"WhatsApp",  software:["whatsapp"], filename:[/^(IMG-|VID-)?\d{8}-WA\d+/i], sizes:[1040,1280,1600,2048], notes:"Recomprime JPEG, elimina EXIF y usa nombres …-WA####."},
      {name:"Instagram", software:["instagram"], sizes:[1080,1350,1440], notes:"Recomprime y elimina EXIF con frecuencia."},
      {name:"Facebook",  software:["facebook"], sizes:[960,2048], notes:"Recomprime y reduce metadatos."},
      {name:"Telegram",  software:["telegram"], sizes:[1280,1920,2560], notes:"Conserva EXIF si envían como archivo."},
      {name:"Google Photos", software:["google"], notes:"Puede reescribir Software/Exif."},
      {name:"iPhone (Cámara)", software:["apple","iphone"], exifKeys:["Make","Model"], notes:"HEIC/JPEG con EXIF completo."},
      {name:"Android (Cámara)", software:["android","samsung","xiaomi","huawei","pixel"], exifKeys:["Make","Model"], notes:"Suele conservar EXIF."}
    ];

    function dmsToDecimal(dms, ref){
      if(!dms || !Array.isArray(dms)) return null;
      const [deg,min,sec]=dms;
      if([deg,min,sec].some(v=>typeof v!=='number')) return null;
      let dec = deg + (min/60) + (sec/3600);
      if(ref==='S' || ref==='W') dec = -dec;
      return dec;
    }

    function asFractionOrNumber(v){
      if(Array.isArray(v) && v.length===2 && typeof v[0]==='number' && typeof v[1]==='number' && v[1]!==0){
        const num=v[0], den=v[1];
        if(num>=den) return (num/den).toFixed(2);
        return `1/${Math.round(den/num)}`;
      }
      return (typeof v==='number')? v : (v ?? '');
    }

    function formatBogota(exifDate){
      if(!exifDate) return null;
      // exifr ya suele entregar Date; pero soportamos string EXIF "YYYY:MM:DD HH:mm:ss"
      let d = exifDate;
      if(typeof exifDate==='string'){
        const parts = exifDate.trim().split(' ');
        if(parts.length===2){
          const iso = parts[0].replaceAll(':','-') + 'T' + parts[1] + 'Z';
          const tmp = new Date(iso);
          if(!Number.isNaN(tmp.getTime())) d = tmp;
        }
      }
      if(!(d instanceof Date) || Number.isNaN(d.getTime())) return null;
      return new Intl.DateTimeFormat('es-CO',{
        year:'numeric',month:'long',day:'numeric',
        hour:'numeric',minute:'numeric',second:'numeric',
        timeZone:'America/Bogota'
      }).format(d);
    }

    async function fileHash(arrayBuffer){
      const hash = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // Lectura binaria: tipo de archivo y segmentos JPEG + calidad aproximada
    function parseBinary(buffer){
      const bytes = new Uint8Array(buffer);
      const view = new DataView(buffer);
      const head = bytes.slice(0,16);
      const hex = [...head].map(b=>b.toString(16).padStart(2,'0')).join(' ');
      let type = "desconocido";

      const isJPEG = bytes[0]==0xFF && bytes[1]==0xD8;
      const isPNG  = bytes[0]==0x89 && bytes[1]==0x50 && bytes[2]==0x4E && bytes[3]==0x47;
      const isWEBP = String.fromCharCode(...bytes.slice(0,4))==="RIFF" && String.fromCharCode(...bytes.slice(8,12))==="WEBP";
      const isHEIC = String.fromCharCode(...bytes.slice(4,12)).includes("ftypheic") || String.fromCharCode(...bytes.slice(4,12)).includes("ftypheif") || String.fromCharCode(...bytes.slice(4,12)).includes("ftypmif1");
      if(isJPEG) type="JPEG";
      else if(isPNG) type="PNG";
      else if(isWEBP) type="WEBP";
      else if(isHEIC) type="HEIC/HEIF";

      let segments=[], progressive=null, jfif=null, exif=null;
      if(isJPEG){
        let i=2;
        while(i<bytes.length){
          if(bytes[i]!==0xFF){ i++; continue; }
          const marker = bytes[i+1];
          if(marker===0xDA) { segments.push("SOS"); break; }
          const len = view.getUint16(i+2);
          segments.push("FF " + marker.toString(16).toUpperCase());
          if(marker===0xC0) progressive=false; // SOF0 baseline
          if(marker===0xC2) progressive=true;  // SOF2 progressive
          if(marker===0xE0) jfif=true;
          if(marker===0xE1) exif=true;
          i += 2 + len;
        }
      }

      // Calidad JPEG heurística leyendo primera tabla DQT (muy orientativa)
      let jpegQuality=null;
      if(isJPEG){
        let i=2;
        while(i<bytes.length){
          if(bytes[i]!==0xFF){i++;continue}
          const marker=bytes[i+1];
          const len=view.getUint16(i+2);
          if(marker===0xDB){
            const q = bytes[i+4];
            if(q<=3) jpegQuality="Muy alta (≈95-100)";
            else if(q<=6) jpegQuality="Alta (≈90)";
            else if(q<=12) jpegQuality="Media (≈75-85)";
            else jpegQuality="Baja (≈50-70)";
            break;
          }
          if(marker===0xDA) break;
          i += 2 + len;
        }
      }
      return {type, hexHead:hex, isJPEG, isPNG, isWEBP, isHEIC, segments, progressive, jfif, exif, jpegQuality};
    }

    function guessPlatform({meta, width, height, software, filename, binary}){
      const hints = [];
      const sw = (software||"").toLowerCase();
      PLATFORM_HINTS.forEach(p=>{
        const hitSW = p.software?.some(s=>sw.includes(s));
        const hitFN = p.filename?.some(rx=>rx.test(filename||""));
        const hitSize = p.sizes?.includes(width)||p.sizes?.includes(height);
        const hitExif = p.exifKeys?.some(k=>k in meta);
        if(hitSW||hitFN||hitSize||hitExif){
          hints.push({platform:p.name, reason: (hitSW?"software ":"")+(hitFN?"nombre ":"")+(hitSize?"tamaño ":"")+(hitExif?"exif ":""), notes:p.notes||""});
        }
      });
      const noMeta = Object.keys(meta||{}).length===0;
      if(noMeta && binary.type==="JPEG"){
        hints.push({platform:"Red social (genérica)", reason:"JPEG sin EXIF/IPTC/XMP", notes:"Varias plataformas eliminan metadatos."});
      }
      if(binary.isJPEG && binary.progressive===true){
        hints.push({platform:"Recompresión web", reason:"JPEG progresivo", notes:"Muchos servicios exportan como progresivo."});
      }
      return hints;
    }

    function detectAI({meta, software, xmpDump, comment}){
      const text = [software, xmpDump, comment].join(" ").toLowerCase();
      let hits = AI_SOFTWARE.filter(k=>text.includes(k));
      const creatorTool = (meta?.CreatorTool||meta?.Software||"").toLowerCase();
      if(AI_SOFTWARE.some(k=>creatorTool.includes(k))) hits.push("creatorTool");
      let score = 0;
      if(hits.length>=1) score += 70;
      if(!("Make" in meta) && !("Model" in meta) && !("LensModel" in meta) && !("DateTimeOriginal" in meta)) score += 20;
      if(("ICCProfileName" in meta)===false && ("ColorSpace" in meta)===false) score += 5;
      return {score: Math.min(100,score), signals: Array.from(new Set(hits))};
    }

    function inferOrigins(meta){
      const text = [
        meta.Software, meta.Model, meta.Make, meta.Artist,
        meta.HostComputer, meta.ImageDescription, meta.CreatorTool
      ].map(x => (x??'')+'').join(' ').toLowerCase();
      const bag=[], has=(k)=>text.includes(k), any=(...ks)=>ks.some(has);
      if(any('photoshop','adobe')) bag.push('Photoshop');
      if(any('lightroom')) bag.push('Lightroom');
      if(any('canva')) bag.push('Canva');
      if(any('capcut')) bag.push('CapCut');
      if(any('snapseed')) bag.push('Snapseed');
      if(any('facebook')) bag.push('Facebook');
      if(any('instagram')) bag.push('Instagram');
      if(any('whatsapp')) bag.push('WhatsApp');
      if(any('telegram')) bag.push('Telegram');
      if(any('iphone','apple')) bag.push('Apple/iPhone');
      if(any('samsung','android','xiaomi','huawei','pixel')) bag.push('Android');
      if(any('nikon','canon','sony','fujifilm','panasonic','olympus','leica','pentax')) bag.push('Cámara dedicada');
      if (bag.length === 0) bag.push('Posible cámara directa / sin editor aparente');
      return [...new Set(bag)];
    }

    /* ======= análisis principal ======= */
    async function analyzeFile(file, dataURL){
      // Cerrar modal
      closeModal.click();

      // Mostrar resultados base
      results.classList.remove('hidden');
      resultImg.src = dataURL;
      resultInfo.textContent = `${file.name} • ${humanSize(file.size)} • ${file.type || 'desconocido'}`;

      // Reset panel
      warnings.replaceChildren();
      indicators.replaceChildren();
      keyGrid.replaceChildren();
      rawBox.textContent='';
      mapLink.replaceChildren();

      // Buffer y binario
      const arrayBuffer = await file.arrayBuffer();
      const binary = parseBinary(arrayBuffer);
      const hash = await fileHash(arrayBuffer);

      // Dimensiones reales
      let width=null, height=null;
      try{
        const bmp = await createImageBitmap(new Blob([arrayBuffer], {type:file.type||'image/*'}));
        width = bmp.width; height = bmp.height; bmp.close?.();
      }catch{}

      // EXIF/IPTC/XMP con exifr
      let meta = {};
      try{
        meta = await exifr.parse(arrayBuffer, {tiff:true, xmp:true, iptc:true, icc:true, jfif:true, ihdr:true, translateValues:true}) || {};
      }catch(e){
        meta = {};
      }

      // Campos normalizados
      const make = meta.Make || '';
      const model = meta.Model || '';
      const lens = meta.LensModel || '';
      const iso = meta.ISO ?? meta.ISOSpeedRatings ?? null;
      const exposure = asFractionOrNumber(meta.ExposureTime);
      const fnum = asFractionOrNumber(meta.FNumber);
      const focal = asFractionOrNumber(meta.FocalLength);
      const dateRaw = meta.DateTimeOriginal || meta.CreateDate || meta.DateTimeDigitized || meta.ModifyDate || '';
      const dateBOG = formatBogota(dateRaw instanceof Date ? dateRaw : String(dateRaw||''));
      const lat = (typeof meta.latitude==='number') ? meta.latitude : dmsToDecimal(meta.GPSLatitude, meta.GPSLatitudeRef);
      const lon = (typeof meta.longitude==='number') ? meta.longitude : dmsToDecimal(meta.GPSLongitude, meta.GPSLongitudeRef);
      const altitude = meta.GPSAltitude ?? null;
      const direction = meta.GPSImgDirection ?? null;
      const colorProfile = meta.ICCProfileName || meta.ColorSpace || '—';

      const software = (meta.Software || meta.CreatorTool || '') + '';
      const swLower = software.toLowerCase();
      const softwareSuspicious = EDITORS.some(s => swLower.includes(s));

      // Heurísticas extra
      const platformHints = guessPlatform({
        meta, width, height, software, filename:file.name, binary
      });
      const xmpDump = meta?.xmp ? JSON.stringify(meta.xmp) : '';
      const ai = detectAI({meta, software, xmpDump, comment: meta?.UserComment||''});

      // Advertencias
      if (Object.keys(meta).length < 5) addWarn('Imagen sin (o con muy pocos) metadatos. Es típico de redes sociales/editores.');
      if(!make && !model) addWarn('Falta marca/modelo de cámara.');
      if(lat==null || lon==null) addWarn('No hay datos de ubicación GPS.');
      if(!dateBOG) addWarn('No se encontró fecha/hora de captura.');
      if(!(iso || exposure || fnum || focal)) addWarn('No hay parámetros de captura (ISO/apertura/exposición/focal).');
      if(softwareSuspicious) addWarn('Software de edición detectado en metadatos.');
      if(binary.isJPEG && binary.progressive===true) addWarn('JPEG progresivo (suele indicar recomprensión web).');

      // Indicadores
      const hasCamera = !!(make || model);
      const hasConfig = !!(iso || exposure || fnum || focal);
      const hasDate = !!dateBOG;
      const hasGPS = (lat!=null && lon!=null);

      addIndicator('Información de Cámara', hasCamera);
      addIndicator('Parámetros de Captura', hasConfig);
      addIndicator('Fecha/Hora válida (Bogotá)', hasDate);
      addIndicator('Datos GPS', hasGPS);
      addIndicator('Software de edición ausente', !softwareSuspicious);

      // Score (ajustado)
      const W = { cam:30, cfg:20, date:15, gps:10, noEdit:25 };
      let score = 0;
      if (hasCamera) score += W.cam;
      if (hasConfig) score += W.cfg;
      if (hasDate) score += W.date;
      if (hasGPS) score += W.gps;
      if (!softwareSuspicious) score += W.noEdit;
      // penalizaciones
      if (ai.score>=70) score = Math.max(0, score-35);
      if (Object.keys(meta).length < 3) score = Math.max(0, score-20);
      score = Math.max(0, Math.min(100, score));

      // Clasificación
      let label = 'No Concluyente';
      let color = 'bg-yellow-500/20 text-yellow-300';
      if (score < 45) { label = 'Imagen Modificada/IA'; color = 'bg-red-500/20 text-red-300'; }
      if (score > 65) { label = 'Imagen Real/Auténtica'; color = 'bg-emerald-500/20 text-emerald-300'; }
      pillText.textContent = label;
      pillIcon.className = `w-9 h-9 rounded-full flex items-center justify-center ${color}`;
      // Combina con IA si aplica
      if(ai.score>=70) pillText.textContent += ' (Señales de IA)';
      confPct.textContent = score + '%';
      bar.style.width = score + '%';

      // Datos clave
      const cam = `${make} ${model}`.trim();
      putKey('Cámara', cam || '—');
      putKey('Objetivo', lens || '—');
      if(width && height) putKey('Dimensiones', `${width} × ${height}px`);
      if(iso!=null) putKey('ISO', iso);
      if(exposure) putKey('Tiempo de exposición', `${exposure} s`);
      if(fnum) putKey('Número f', `f/${fnum}`);
      if(focal) putKey('Distancia focal', `${focal} mm`);
      putKey('Software', software || '—');
      putKey('Perfil de color', colorProfile);
      putKey('Formato', binary.type + (binary.progressive===true? ' (progresivo)': (binary.progressive===false?' (baseline)':'')));
      if(binary.jpegQuality) putKey('Calidad JPEG (aprox.)', binary.jpegQuality);
      putKey('Hash (SHA-256)', `<span class="mono">${(await fileHash(arrayBuffer)).slice(0,16)}…</span>`);
      putKey('Fecha original', (dateRaw instanceof Date)? dateRaw.toISOString() : (String(dateRaw||'—')));
      putKey('Fecha (Bogotá GMT-5)', dateBOG || '—');

      if(lat!=null && lon!=null){
        putKey('Latitud', lat.toFixed(6));
        putKey('Longitud', lon.toFixed(6));
        const a = document.createElement('a');
        a.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=15/${lat}/${lon}`;
        a.target = '_blank';
        a.rel='noopener';
        a.className='text-brand-300 hover:text-brand-200 underline';
        a.textContent='Ver ubicación en OpenStreetMap';
        mapLink.appendChild(a);
      }
      if(altitude!=null) putKey('Altitud', altitude + ' m');
      if(direction!=null) putKey('Dirección', direction + '°');

      const origins = inferOrigins(meta);
      putKey('Pistas de Origen', origins.join(', '));

      // Plataforma probable
      if(platformHints.length){
        putKey('Plataforma probable', platformHints.map(h=>`${h.platform} (${h.reason.trim()})`).join(' · '));
      }

      // Dump técnico
      const dump = {
        _archivo: { nombre:file.name, tipo:file.type||'desconocido', bytes:file.size },
        _dimensiones: { width, height },
        _binario: { tipo:binary.type, cabecera_16b:binary.hexHead, segmentosJPEG:binary.segments, progresivo:binary.progressive, JFIF:binary.jfif, EXIF:binary.exif, calidadJPEG:binary.jpegQuality },
        _ai: { score: ai.score, señales: ai.signals },
        _plataforma: platformHints,
        exif_iptc_xmp: meta
      };
      rawBox.textContent = JSON.stringify(dump, null, 2);

      // Render final
      resultInfo.innerHTML = `${file.name} • ${humanSize(file.size)} • ${file.type || 'desconocido'}`;
    }

  </script>
</body>
</html>

